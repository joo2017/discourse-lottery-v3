// assets/javascripts/discourse/initializers/lottery-composer-integration.js
import { withPluginApi } from "discourse/lib/plugin-api";
import LotteryFormModal from "../components/modal/lottery-form-modal";

export default {
  name: "lottery-composer-integration",
  initialize() {
    withPluginApi("1.4.0", (api) => {
      console.log("ğŸ² Lottery: åˆå§‹åŒ–ç¼–è¾‘å™¨é›†æˆ");

      api.serializeOnCreate('lottery');
      api.serializeToDraft('lottery');
      api.serializeToTopic('lottery', 'topic.lottery');

      function canInsertLottery() {
        const composer = api.container.lookup("controller:composer");
        if (!composer) return false;

        const siteSettings = api.container.lookup("service:site-settings");
        const allowedCategories = siteSettings?.lottery_allowed_categories;
        
        if (!allowedCategories) return true;

        const allowedIds = allowedCategories
          .split("|")
          .map(id => Number(id.trim()))
          .filter(id => !isNaN(id) && id > 0);

        const currentCategoryId = Number(composer.get("model.categoryId") || 0);
        return allowedIds.includes(currentCategoryId);
      }

      api.onToolbarCreate((toolbar) => {
        toolbar.addButton({
          title: "æ’å…¥æŠ½å¥–",
          id: "insertLottery", 
          group: "extras",
          icon: "dice",
          shortcut: "Ctrl+Shift+L",
          perform: (e) => {
            const siteSettings = api.container.lookup("service:site-settings");
            
            if (!siteSettings?.lottery_enabled) {
              alert("æŠ½å¥–åŠŸèƒ½å·²è¢«ç®¡ç†å‘˜å…³é—­");
              return;
            }

            if (!canInsertLottery()) {
              alert("å½“å‰åˆ†ç±»ä¸æ”¯æŒæŠ½å¥–åŠŸèƒ½");
              return;
            }

            const modal = api.container.lookup("service:modal");
            const composer = api.container.lookup("controller:composer");
            
            modal.show(LotteryFormModal, {
              model: { 
                toolbarEvent: e,
                composer: composer,
                siteSettings: siteSettings
              }
            });
          }
        });
      });

      console.log("ğŸ² Lottery: ç¼–è¾‘å™¨é›†æˆåˆå§‹åŒ–å®Œæˆ");
    });
  },
};
